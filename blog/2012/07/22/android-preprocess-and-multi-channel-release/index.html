
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Android编译预处理及多渠道发布 - Simple Coding, Better Life</title>
  <meta name="author" content="Jackyche">

  
  <meta name="description" content="Android游戏在国内的渠道实在太乱了，像UC、91、QQ、应用汇、安智市场、N多网这样的平台，大大小小几十个。一款游戏如果需要在所有的渠道上发布，还得为每个渠道定制相应的版本。这种活如果人肉一个渠道一个渠道去做，有点劳民伤财。考虑到不同渠道的版本在代码和资源上99%都是相同的， &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://jackyche.github.com/blog/2012/07/22/android-preprocess-and-multi-channel-release/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Simple Coding, Better Life" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-33231745-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Simple Coding, Better Life</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:jackyche.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about">About Me</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Android编译预处理及多渠道发布</h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-07-22T11:06:00+08:00" pubdate data-updated="true">Jul 22<span>nd</span>, 2012</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>Android游戏在国内的渠道实在太乱了，像UC、91、QQ、应用汇、安智市场、N多网这样的平台，大大小小几十个。一款游戏如果需要在所有的渠道上发布，还得为每个渠道定制相应的版本。这种活如果人肉一个渠道一个渠道去做，有点劳民伤财。考虑到不同渠道的版本在代码和资源上99%都是相同的，这种事情应该用脚本去完成。</p>

<p>五六年前J2ME游戏经常需要为上百款设备做适配，当时比较流行的发布策略是<a href="http://ant.apache.org/">Ant</a> + <a href="http://antenna.sourceforge.net/">Antenna</a>。考虑了一下，这种策略对于应付Android的多渠道也是绰绰有余的。</p>

<p>这篇文章分享一下基于Ant + Antenna的Android游戏多渠道发布策略。</p>

<!-- more -->


<p>不同渠道的版本，通常情况下差异在两个方面：少量代码 + 资源。</p>

<h3>首先处理代码的差异性：</h3>

<p>在C/C++里面，因为有#ifdef，#ifndef这种条件预编译宏的存在，可以很方便为每个渠道做代码的定制化，但是Java不支持这种方式。那就是说，一份Java代码只能编译出一个执行文件(不要跟我说动态运行这件事，这不是编译期的事情)，那我们如何来解决这个问题呢。换一种思路来考虑问题：事实上我们并不排斥多份编译代码的存在，我们关心的是能否只维护一份代码。</p>

<p>Antenna用一种取巧的方式解决了这个问题：每次通过对原始代码做预处理，得到一份中间代码，然后对这份中间代码进行编译发布。</p>

<p>Antenna提供了类似C/C++里的条件预编译宏，具体支持的宏定义可以参考<a href="http://antenna.sourceforge.net/wtkpreprocess.php">这里</a>。比较大的差别在于，Antenna的预编译宏是以<code>//</code>开头的，它以注释的形式存在于代码中，不会导致原始代码的编译错误。</p>

<p>下面是一个示例：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'> <span class="c1">//#ifdef CHANNEL_91</span>
</span><span class='line'>  <span class="c1">//@ setContentView(R.layout.hello_activity_91);</span>
</span><span class='line'>  <span class="c1">//#elifdef CHANNEL_UC</span>
</span><span class='line'>      <span class="n">setContentView</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">hello_activity_uc</span><span class="o">);</span>
</span><span class='line'>  <span class="c1">//#elifdef CHANNEL_QQ</span>
</span><span class='line'>  <span class="c1">//@ setContentView(R.layout.hello_activity_qq);</span>
</span><span class='line'>  <span class="c1">//#endif</span>
</span></code></pre></td></tr></table></div></figure>


<p>然后我们可以定义Ant任务</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'>  <span class="c">&lt;!-- wtk is not neccessory ,but still need to define wtk.home --&gt;</span>
</span><span class='line'>  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;wtk.home&quot;</span> <span class="na">value=</span><span class="s">&quot;/tmp&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;path</span> <span class="na">id=</span><span class="s">&quot;antenna.lib&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;pathelement</span> <span class="na">location=</span><span class="s">&quot;antenna/antenna-bin-1.2.1-beta.jar&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>   <span class="nt">&lt;/path&gt;</span>
</span><span class='line'>   <span class="c">&lt;!-- Defining Antenna&#39;s WTK tasks hard coded, do NOT ask --&gt;</span>
</span><span class='line'>  <span class="nt">&lt;taskdef</span> <span class="na">name=</span><span class="s">&quot;preprocess&quot;</span> <span class="na">classname=</span><span class="s">&quot;de.pleumann.antenna.WtkPreprocess&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;classpath</span> <span class="na">refid=</span><span class="s">&quot;antenna.lib&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/taskdef&gt;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="c">&lt;!-- </span>
</span><span class='line'><span class="c">    input: macros.definition </span>
</span><span class='line'><span class="c">    environment: srcdir, destdir</span>
</span><span class='line'><span class="c">  --&gt;</span>
</span><span class='line'>  <span class="nt">&lt;target</span> <span class="na">name=</span><span class="s">&quot;preproc&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;echo</span> <span class="na">message=</span><span class="s">&quot;proproc: ${version.definition}&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>      <span class="nt">&lt;preprocess</span> <span class="na">srcdir=</span><span class="s">&quot;${srcdir}&quot;</span> <span class="na">destdir=</span><span class="s">&quot;${outdir-preprocess}&quot;</span> <span class="na">symbols=</span><span class="s">&quot;${macros.definition}&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/target&gt;</span>
</span><span class='line'>  
</span><span class='line'>  <span class="nt">&lt;target</span> <span class="na">name=</span><span class="s">&quot;preproc_uc&quot;</span> <span class="na">description=</span><span class="s">&quot;release for uc platform&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;antcall</span> <span class="na">target=</span><span class="s">&quot;preproc&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>          <span class="nt">&lt;param</span> <span class="na">name=</span><span class="s">&quot;macros.definition&quot;</span> <span class="na">value=</span><span class="s">&quot;CHANNEL_UC&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/antcall&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/target&gt;</span>
</span><span class='line'>  
</span><span class='line'>  <span class="nt">&lt;target</span> <span class="na">name=</span><span class="s">&quot;preproc_qq&quot;</span> <span class="na">description=</span><span class="s">&quot;release for qq platform&quot;</span> <span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;antcall</span> <span class="na">target=</span><span class="s">&quot;preproc&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>          <span class="nt">&lt;param</span> <span class="na">name=</span><span class="s">&quot;macros.definition&quot;</span> <span class="na">value=</span><span class="s">&quot;CHANNEL_QQ&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/antcall&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/target&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>这里有两个Ant任务：<code>preproc_uc</code>和<code>preproc_qq</code>。当我们执行<code>preproc_uc</code>的时候，会得出以下的中间代码：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'> <span class="c1">//#ifdef CHANNEL_91</span>
</span><span class='line'>  <span class="c1">//@ setContentView(R.layout.hello_activity_91);</span>
</span><span class='line'>  <span class="c1">//#elifdef CHANNEL_UC</span>
</span><span class='line'>      <span class="n">setContentView</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">hello_activity_uc</span><span class="o">);</span>
</span><span class='line'>  <span class="c1">//#elifdef CHANNEL_QQ</span>
</span><span class='line'>  <span class="c1">//@ setContentView(R.layout.hello_activity_qq);</span>
</span><span class='line'>  <span class="c1">//#endif</span>
</span></code></pre></td></tr></table></div></figure>


<p>而当我们执行<code>preproc_qq</code>的时候，则会得出以下的中间代码：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'> <span class="c1">//#ifdef CHANNEL_91</span>
</span><span class='line'>  <span class="c1">//@ setContentView(R.layout.hello_activity_91);</span>
</span><span class='line'>  <span class="c1">//#elifdef CHANNEL_UC</span>
</span><span class='line'>  <span class="c1">//@    setContentView(R.layout.hello_activity_uc);</span>
</span><span class='line'>  <span class="c1">//#elifdef CHANNEL_QQ</span>
</span><span class='line'>      <span class="n">setContentView</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">hello_activity_qq</span><span class="o">);</span>
</span><span class='line'>  <span class="c1">//#endif</span>
</span></code></pre></td></tr></table></div></figure>


<p>之后我们就可以根据生成的不同中间代码，编译不同的渠道版本。</p>

<p>Antenna支持多个编译宏的形式，在这段示例里<code>macros.definition</code>的编译宏参数以逗号分隔就可以了，如：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'>  <span class="nt">&lt;target</span> <span class="na">name=</span><span class="s">&quot;preproc_91&quot;</span> <span class="na">description=</span><span class="s">&quot;release for qq platform&quot;</span> <span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;antcall</span> <span class="na">target=</span><span class="s">&quot;preproc&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>          <span class="nt">&lt;param</span> <span class="na">name=</span><span class="s">&quot;macros.definition&quot;</span> <span class="na">value=</span><span class="s">&quot;CHANNEL_91, FLAG_91, PARAMS_91&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/antcall&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/target&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>同样它也支持一系列的条件判断语句，具体请参考<a href="http://antenna.sourceforge.net/wtkpreprocess.php">这里</a>。</p>

<p>这里需要注意的是，Antenna在执行的时候，会把不需要的相应代码块用<code>//@</code>注释掉。</p>

<h3>接下来解决资源打包问题：</h3>

<p>Android打包应用，一般会经过以下几个步骤：</p>

<ol>
<li>用aapt命令生成R.java文件</li>
<li>用javac命令编译java源文件生成class文件</li>
<li>用dx将class文件转换成classes.dex文件</li>
<li>用aapt命令生成资源包文件resources.ap_</li>
<li>用apkbuilder打包资源和classes.dex文件,生成unsigned.apk</li>
<li>用jarsinger命令对apk认证,生成signed.apk</li>
<li>用jarsinger的verify功能对apk进行校验</li>
<li>做相应的发布清理工作</li>
</ol>


<p>我们可以用Ant脚本定义每一个步骤：</p>

<figure class='code'><figcaption><span>生成R.java文件  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'>    <span class="nt">&lt;target</span> <span class="na">name=</span><span class="s">&quot;gen-R&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">&lt;echo&gt;</span>Generating R.java from the resources...<span class="nt">&lt;/echo&gt;</span>
</span><span class='line'>        <span class="nt">&lt;exec</span> <span class="na">executable=</span><span class="s">&quot;${aapt}&quot;</span> <span class="na">failonerror=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>            <span class="nt">&lt;arg</span> <span class="na">value=</span><span class="s">&quot;package&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>            <span class="nt">&lt;arg</span> <span class="na">value=</span><span class="s">&quot;-f&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>            <span class="nt">&lt;arg</span> <span class="na">value=</span><span class="s">&quot;-m&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>            <span class="nt">&lt;arg</span> <span class="na">value=</span><span class="s">&quot;-J&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>            <span class="nt">&lt;arg</span> <span class="na">value=</span><span class="s">&quot;${outdir-gen}&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>            <span class="nt">&lt;arg</span> <span class="na">value=</span><span class="s">&quot;-S&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>            <span class="nt">&lt;arg</span> <span class="na">value=</span><span class="s">&quot;${resource-dir}&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>            <span class="nt">&lt;arg</span> <span class="na">value=</span><span class="s">&quot;-M&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>            <span class="nt">&lt;arg</span> <span class="na">value=</span><span class="s">&quot;${manifest-xml}&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>            <span class="nt">&lt;arg</span> <span class="na">value=</span><span class="s">&quot;-I&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>            <span class="nt">&lt;arg</span> <span class="na">value=</span><span class="s">&quot;${android-jar}&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/exec&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/target&gt;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>编译java源文件  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'>    <span class="nt">&lt;target</span> <span class="na">name=</span><span class="s">&quot;compile&quot;</span> <span class="na">depends=</span><span class="s">&quot;gen-R&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">&lt;echo&gt;</span>Compiling java source code...<span class="nt">&lt;/echo&gt;</span>
</span><span class='line'>        <span class="nt">&lt;javac</span> <span class="na">encoding=</span><span class="s">&quot;utf-8&quot;</span> <span class="na">target=</span><span class="s">&quot;1.6&quot;</span> <span class="na">destdir=</span><span class="s">&quot;${outdir-classes}&quot;</span> <span class="na">bootclasspath=</span><span class="s">&quot;${android-jar}&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>          <span class="nt">&lt;src</span> <span class="na">path=</span><span class="s">&quot;${outdir-preprocess}&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>          <span class="nt">&lt;src</span> <span class="na">path=</span><span class="s">&quot;${outdir-gen}&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>          
</span><span class='line'>          <span class="nt">&lt;classpath&gt;</span>
</span><span class='line'>                <span class="nt">&lt;fileset</span> <span class="na">dir=</span><span class="s">&quot;${external-lib}&quot;</span> <span class="na">includes=</span><span class="s">&quot;*.jar&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>            <span class="nt">&lt;/classpath&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/javac&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/target&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>这里需要编译生成的R.cpp，以及经过Antenna处理过的中间代码。</p>

<figure class='code'><figcaption><span>将class文件转换成classes.dex文件  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'>    <span class="nt">&lt;target</span> <span class="na">name=</span><span class="s">&quot;dex&quot;</span> <span class="na">depends=</span><span class="s">&quot;compile&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">&lt;echo&gt;</span>Converting compiled files and external libraries into a .dex file...<span class="nt">&lt;/echo&gt;</span>
</span><span class='line'>        <span class="nt">&lt;exec</span> <span class="na">executable=</span><span class="s">&quot;${dx}&quot;</span> <span class="na">failonerror=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>            <span class="nt">&lt;arg</span> <span class="na">value=</span><span class="s">&quot;--dex&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>            <span class="nt">&lt;arg</span> <span class="na">value=</span><span class="s">&quot;--output=${dex-ospath}&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>            <span class="nt">&lt;arg</span> <span class="na">value=</span><span class="s">&quot;${outdir-classes-ospath}&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>            <span class="nt">&lt;arg</span> <span class="na">value=</span><span class="s">&quot;${external-lib-ospath}&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/exec&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/target&gt;</span>   
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>生成资源包文件resources.ap_  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'>    <span class="nt">&lt;target</span> <span class="na">name=</span><span class="s">&quot;package-res-and-assets&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">&lt;echo&gt;</span>Packaging resources and assets...<span class="nt">&lt;/echo&gt;</span>
</span><span class='line'>        <span class="nt">&lt;exec</span> <span class="na">executable=</span><span class="s">&quot;${aapt}&quot;</span> <span class="na">failonerror=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>            <span class="nt">&lt;arg</span> <span class="na">value=</span><span class="s">&quot;package&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>            <span class="nt">&lt;arg</span> <span class="na">value=</span><span class="s">&quot;-f&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>            <span class="nt">&lt;arg</span> <span class="na">value=</span><span class="s">&quot;-M&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>            <span class="nt">&lt;arg</span> <span class="na">value=</span><span class="s">&quot;${manifest-xml}&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>            <span class="nt">&lt;arg</span> <span class="na">value=</span><span class="s">&quot;-S&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>            <span class="nt">&lt;arg</span> <span class="na">value=</span><span class="s">&quot;${resource-dir}&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>            <span class="nt">&lt;arg</span> <span class="na">value=</span><span class="s">&quot;-A&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>            <span class="nt">&lt;arg</span> <span class="na">value=</span><span class="s">&quot;${asset-dir}&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>            <span class="nt">&lt;arg</span> <span class="na">value=</span><span class="s">&quot;-I&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>            <span class="nt">&lt;arg</span> <span class="na">value=</span><span class="s">&quot;${android-jar}&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>            <span class="nt">&lt;arg</span> <span class="na">value=</span><span class="s">&quot;-F&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>            <span class="nt">&lt;arg</span> <span class="na">value=</span><span class="s">&quot;${resources-package}&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/exec&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/target&gt;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>打包未签名apk  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'>    <span class="nt">&lt;target</span> <span class="na">name=</span><span class="s">&quot;package&quot;</span> <span class="na">depends=</span><span class="s">&quot;dex, package-res-and-assets&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">&lt;echo&gt;</span>Packaging unsigned apk for release...<span class="nt">&lt;/echo&gt;</span>
</span><span class='line'>        <span class="nt">&lt;exec</span> <span class="na">executable=</span><span class="s">&quot;${apkbuilder}&quot;</span> <span class="na">failonerror=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>            <span class="c">&lt;!--&lt;arg value=&quot;${out-unsigned-package-ospath}&quot; /&gt;--&gt;</span>
</span><span class='line'>          <span class="nt">&lt;arg</span> <span class="na">value=</span><span class="s">&quot;${out-unsigned-package-ospath}&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>            <span class="nt">&lt;arg</span> <span class="na">value=</span><span class="s">&quot;-u&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>            <span class="nt">&lt;arg</span> <span class="na">value=</span><span class="s">&quot;-z&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>            <span class="nt">&lt;arg</span> <span class="na">value=</span><span class="s">&quot;${resources-package-ospath}&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>            <span class="nt">&lt;arg</span> <span class="na">value=</span><span class="s">&quot;-f&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>            <span class="nt">&lt;arg</span> <span class="na">value=</span><span class="s">&quot;${dex-ospath}&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>            <span class="nt">&lt;arg</span> <span class="na">value=</span><span class="s">&quot;-rf&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>            <span class="nt">&lt;arg</span> <span class="na">value=</span><span class="s">&quot;${srcdir-ospath}&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/exec&gt;</span>
</span><span class='line'>        <span class="nt">&lt;echo&gt;</span>It will need to be signed with jarsigner before being published.<span class="nt">&lt;/echo&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/target&gt;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>对apk进行认证  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'>    <span class="nt">&lt;target</span> <span class="na">name=</span><span class="s">&quot;jarsigner&quot;</span> <span class="na">depends=</span><span class="s">&quot;package&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">&lt;echo&gt;</span>Packaging signed apk for release...<span class="nt">&lt;/echo&gt;</span>
</span><span class='line'>        <span class="nt">&lt;exec</span> <span class="na">executable=</span><span class="s">&quot;${jarsigner}&quot;</span> <span class="na">failonerror=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>            <span class="nt">&lt;arg</span> <span class="na">value=</span><span class="s">&quot;-keystore&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>            <span class="nt">&lt;arg</span> <span class="na">value=</span><span class="s">&quot;${keystore-file}&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>            <span class="nt">&lt;arg</span> <span class="na">value=</span><span class="s">&quot;-storepass&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>            <span class="nt">&lt;arg</span> <span class="na">value=</span><span class="s">&quot;qwer1234&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>            <span class="nt">&lt;arg</span> <span class="na">value=</span><span class="s">&quot;-keypass&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>            <span class="nt">&lt;arg</span> <span class="na">value=</span><span class="s">&quot;qwer1234&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>            <span class="nt">&lt;arg</span> <span class="na">value=</span><span class="s">&quot;-signedjar&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>            <span class="nt">&lt;arg</span> <span class="na">value=</span><span class="s">&quot;${outdir-release}/${release.name}.apk&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>            <span class="nt">&lt;arg</span> <span class="na">value=</span><span class="s">&quot;${out-unsigned-package-ospath}&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>            <span class="c">&lt;!-- don&#39;t forget alis of certification --&gt;</span>
</span><span class='line'>            <span class="nt">&lt;arg</span> <span class="na">value=</span><span class="s">&quot;release.keystore&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/exec&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/target&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>如果你没有生成keystore文件，需要用以下命令生成：</p>

<pre><code>keytool -genkey -v -keystore &lt;file_name&gt; -alias &lt;alias_name&gt; -keyalg RSA -validity 10000
</code></pre>

<p>照着提示生成就可以了。</p>

<p>这里需要注意的是jarsigner需要提供keystore的别名。</p>

<figure class='code'><figcaption><span>校验认证  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'>    <span class="nt">&lt;target</span> <span class="na">name=</span><span class="s">&quot;verifysign&quot;</span> <span class="na">depends=</span><span class="s">&quot;jarsigner&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">&lt;echo&gt;</span>Verfify signed apk for release...<span class="nt">&lt;/echo&gt;</span>
</span><span class='line'>        <span class="nt">&lt;exec</span> <span class="na">executable=</span><span class="s">&quot;${jarsigner}&quot;</span> <span class="na">failonerror=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>            <span class="nt">&lt;arg</span> <span class="na">value=</span><span class="s">&quot;-verify&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>            <span class="nt">&lt;arg</span> <span class="na">value=</span><span class="s">&quot;-verbose&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>            <span class="nt">&lt;arg</span> <span class="na">value=</span><span class="s">&quot;${outdir-release}/${release.name}.apk&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/exec&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/target&gt;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>做发布清理  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'>    <span class="nt">&lt;target</span> <span class="na">name=</span><span class="s">&quot;release&quot;</span> <span class="na">depends=</span><span class="s">&quot;verifysign&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">&lt;delete</span> <span class="na">file=</span><span class="s">&quot;${out-unsigned-package-ospath}&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>        <span class="nt">&lt;echo&gt;</span>APK is released. path:${outdir-release}/${release.name}.apk<span class="nt">&lt;/echo&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/target&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>有了这些脚本，我们就可以对资源打包做灵活性控制了。例如我们对于不同的渠道，可以用不同的<code>AndroidManifest.xml</code>，打包不同的<code>res</code>文件夹，诸如此类。</p>

<p>最后我在GitHub上写了一个示例的工程，仅供参考：<a href="https://github.com/jackyche/AndroidAntennaExample">AndroidAntennaExample</a></p>

<h3>参考资料</h3>

<ul>
<li><a href="http://antenna.sourceforge.net/wtkpreprocess.php">http://antenna.sourceforge.net/wtkpreprocess.php</a></li>
<li><a href="http://stackoverflow.com/questions/1797930/how-to-get-eclipse-to-recognize-preprocessor-statements">http://stackoverflow.com/questions/1797930/how-to-get-eclipse-to-recognize-preprocessor-statements</a></li>
<li><a href="http://www.cnblogs.com/qianxudetianxia/archive/2012/07/04/2573687.html">http://www.cnblogs.com/qianxudetianxia/archive/2012/07/04/2573687.html</a></li>
</ul>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Jackyche</span></span>

      








  


<time datetime="2012-07-22T11:06:00+08:00" pubdate data-updated="true">Jul 22<span>nd</span>, 2012</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/android/'>Android</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://jackyche.github.com/blog/2012/07/22/android-preprocess-and-multi-channel-release/" data-via="" data-counturl="http://jackyche.github.com/blog/2012/07/22/android-preprocess-and-multi-channel-release/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2012/07/08/smart-pointer-study-notes/" title="Previous Post: std::tr1::shared_ptr学习笔记">&laquo; std::tr1::shared_ptr学习笔记</a>
      
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/07/22/android-preprocess-and-multi-channel-release/">Android编译预处理及多渠道发布</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/07/08/smart-pointer-study-notes/">std::tr1::shared_ptr学习笔记</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/07/08/markdown-syntax-study-notes/">Markdown语法学习笔记</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/07/07/how-to-create-github-pages-with-octopress/">搭建基于octopress的GitHub博客</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Categories</h1>
    <ul id="category-list"><li><a href='/blog/categories/android'>Android (1)</a></li><li><a href='/blog/categories/c-c-'>C/C++ (1)</a></li></ul>
</section>






  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Jackyche -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'jackyche';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://jackyche.github.com/blog/2012/07/22/android-preprocess-and-multi-channel-release/';
        var disqus_url = 'http://jackyche.github.com/blog/2012/07/22/android-preprocess-and-multi-channel-release/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
